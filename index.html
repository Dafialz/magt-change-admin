<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>MAGT — Change Jetton Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TonConnect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@2.0.8/dist/tonconnect-ui.min.js"></script>
  <!-- TonWeb primary CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.61/dist/tonweb.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 760px; margin: 24px auto; padding: 0 12px; }
    label { display:block; margin-top:12px; font-weight:600;}
    input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;}
    button { padding:12px 16px; border-radius:12px; border:0; cursor:pointer; background:#2f7cf6; color:white; font-weight:600; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .muted { color:#666; font-size:13px; }
    pre { background:#f7f7f7; padding:12px; border-radius:10px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>MAGT — зміна власника (admin) Jetton-Minter</h1>
  <p class="muted">Підключи свій гаманець (теперішній Admin), перевір адреси нижче й натисни <b>Change owner</b>. Комісія ~0.05–0.1 TON.</p>

  <div id="tc"></div>

  <label>Jetton Minter address</label>
  <input id="minter" value="EQDxQWrZz7v11EqVvtDv1sFLmvK1hNpxrQpvMXhjBasUSXjx" />

  <label>New admin address</label>
  <input id="newAdmin" value="UQAZ4VN0UzqZ570GjM3EpDFszzs4zsw8cD8_YfC0M2ca6N17" />

  <label>Gas (in nanotons)</label>
  <input id="amount" value="70000000" />

  <div class="row" style="margin-top:16px">
    <button id="send">Change owner</button>
    <button id="test">Build payload only</button>
  </div>

  <pre id="log"></pre>

<script>
(async () => {
  // ---------- helpers ----------
  function log(msg) {
    const el = document.getElementById('log');
    el.textContent += String(msg) + "\n";
    el.scrollTop = el.scrollHeight;
  }
  function loadScript(url) {
    return new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = url; s.onload = () => res(); s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  async function ensureTonWeb() {
    if (window.TonWeb) return true;
    try {
      await loadScript("https://unpkg.com/tonweb@0.0.61/dist/tonweb.min.js");
    } catch (e) {
      log("Не вдалося підвантажити TonWeb з unpkg");
      return false;
    }
    return !!window.TonWeb;
  }

  // ---------- manifest path (root або /mint/) ----------
  const basePath = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
  const manifestUrl = basePath + "tonconnect-manifest.json";

  // ---------- TonConnectUI: тільки Tonkeeper, без автопідключення ----------
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl,
    buttonRootId: "tc",
    restoreConnection: false,
    walletsList: {
      includeWallets: [
        {
          appName: "tonkeeper",
          name: "Tonkeeper",
          bridgeUrl: "https://bridge.tonapi.io/bridge",
          universalLink: "https://app.tonkeeper.com/ton-connect",
          deepLink: "tonkeeper://ton-connect"
        }
      ]
    }
  });
  try { await tonConnectUI.disconnect(); } catch {}

  // ---------- validation (regex only, без TonWeb) ----------
  function isValidAddress(addr) {
    // user-friendly EQ/UQ
    const uf = /^(EQ|UQ)[A-Za-z0-9_-]{48,}$/;
    // raw 0:.. або -1:..
    const raw = /^(-?1|0):[0-9a-fA-F]{64}$/;
    return uf.test(addr) || raw.test(addr);
  }

  // ---------- payload builder ----------
  function buildChangeAdminPayload(newAdminAddress) {
    const cell = new window.TonWeb.boc.Cell();
    cell.bits.writeUint(0x6501f354, 32);     // change_admin op
    const qid = BigInt(Date.now());          // query_id
    cell.bits.writeUint(qid, 64);
    const addr = new window.TonWeb.utils.Address(newAdminAddress);
    cell.bits.writeAddress(addr);
    return window.TonWeb.utils.bytesToBase64(cell.toBoc({ idx: false }));
  }

  function sanitizeAmount(a) {
    const s = String(a).trim();
    if (!/^\d+$/.test(s)) return null;
    return s; // nanotons as string
  }

  // ---------- send ----------
  async function send() {
    const minter = document.getElementById('minter').value.trim();
    const newAdmin = document.getElementById('newAdmin').value.trim();
    const amountRaw = document.getElementById('amount').value;

    if (!minter || !newAdmin) return alert('Заповни адреси мінтера і нового адміна');
    if (!isValidAddress(minter)) return alert('Minter address некоректна');
    if (!isValidAddress(newAdmin)) return alert('New admin address некоректна');

    const ok = await ensureTonWeb();
    if (!ok) return alert('TonWeb не завантажився. Перевір інтернет/блокувальники і онови сторінку.');

    const amount = sanitizeAmount(amountRaw);
    if (!amount) return alert('Gas має бути цілим числом у нанотонах (наприклад, 70000000)');

    const payload = buildChangeAdminPayload(newAdmin);
    const tx = {
      validUntil: Math.floor(Date.now() / 1000) + 360,
      messages: [{ address: minter, amount, payload }]
    };

    try {
      await tonConnectUI.sendTransaction(tx);
      log("Відправлено! Перевір поле Admin у Tonviewer/Minter.");
    } catch (e) {
      console.error(e); log("Помилка: " + (e && e.message ? e.message : e));
    }
  }

  document.getElementById('send').onclick = send;

  document.getElementById('test').onclick = async () => {
    const newAdmin = document.getElementById('newAdmin').value.trim();
    if (!isValidAddress(newAdmin)) return alert('New admin address некоректна');
    const ok = await ensureTonWeb();
    if (!ok) return alert('TonWeb не завантажився.');
    const payload = buildChangeAdminPayload(newAdmin);
    log("Payload (base64 BOC):\n" + payload);
  };
})();
</script>
</body>
</html>
