<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>MAGT — Change Jetton Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TonConnect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@2.0.8/dist/tonconnect-ui.min.js"></script>
  <!-- TonWeb for building BOC -->
  <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.61/dist/tonweb.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 760px; margin: 24px auto; padding: 0 12px; }
    label { display:block; margin-top:12px; font-weight:600;}
    input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px;}
    button { padding:12px 16px; border-radius:12px; border:0; cursor:pointer; background:#2f7cf6; color:white; font-weight:600; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .muted { color:#666; font-size:13px; }
    pre { background:#f7f7f7; padding:12px; border-radius:10px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>MAGT — зміна власника (admin) Jetton-Minter</h1>
  <p class="muted">Підключи свій гаманець (теперішній Admin), перевір адреси нижче й натисни <b>Change owner</b>. Комісія ~0.05–0.1 TON.</p>

  <div id="tc"></div>

  <label>Jetton Minter address</label>
  <input id="minter" value="UQBDooPilphbndrSB1RdtkyZrnWctibsl356IvU7_jOxh4UT" />

  <label>New admin address</label>
  <input id="newAdmin" value="UQAZ4VN0UzqZ570GjM3EpDFszzs4zsw8cD8_YfC0M2ca6N17" />

  <label>Gas (in nanotons)</label>
  <input id="amount" value="70000000" />

  <div class="row" style="margin-top:16px">
    <button id="send">Change owner</button>
    <button id="test">Build payload only</button>
  </div>

  <pre id="log"></pre>

<script>
(async () => {
  // Маніфест береться відносно поточної папки (працює як у корені, так і в /mint/)
  const basePath = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
  const manifestUrl = basePath + "tonconnect-manifest.json";

  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl,
    buttonRootId: "tc"
  });

  function log(msg) {
    const el = document.getElementById('log');
    el.textContent += String(msg) + "\n";
    el.scrollTop = el.scrollHeight;
  }

  function isValidAddress(addr) {
    try { new TonWeb.utils.Address(addr); return true; } catch { return false; }
  }

  // Будуємо тіло повідомлення: op(32) + query_id(64) + new_admin(address)
  function buildChangeAdminPayload(newAdminAddress) {
    const cell = new TonWeb.boc.Cell();
    cell.bits.writeUint(0x6501f354, 32);     // change_admin op
    const qid = BigInt(Date.now());          // query_id
    cell.bits.writeUint(qid, 64);
    const addr = new TonWeb.utils.Address(newAdminAddress);
    cell.bits.writeAddress(addr);
    const boc = TonWeb.utils.bytesToBase64(cell.toBoc({ idx: false }));
    return boc;
  }

  function sanitizeAmount(a) {
    const s = String(a).trim();
    if (!/^\d+$/.test(s)) return null;
    return s; // nanotons as string
  }

  async function send() {
    const minter = document.getElementById('minter').value.trim();
    const newAdmin = document.getElementById('newAdmin').value.trim();
    const amountRaw = document.getElementById('amount').value;

    if (!minter || !newAdmin) {
      alert('Заповни адреси мінтера і нового адміна');
      return;
    }
    if (!isValidAddress(minter)) {
      alert('Minter address некоректна');
      return;
    }
    if (!isValidAddress(newAdmin)) {
      alert('New admin address некоректна');
      return;
    }
    const amount = sanitizeAmount(amountRaw);
    if (!amount) {
      alert('Gas має бути цілим числом у нанотонах (наприклад, 70000000)');
      return;
    }

    const payload = buildChangeAdminPayload(newAdmin);
    const tx = {
      validUntil: Math.floor(Date.now() / 1000) + 360, // 6 хв
      messages: [{ address: minter, amount, payload }]
    };

    try {
      await tonConnectUI.sendTransaction(tx);
      log("Відправлено! Перевір поле Admin у Tonviewer/Minter.");
    } catch (e) {
      console.error(e);
      log("Помилка: " + (e && e.message ? e.message : e));
    }
  }

  document.getElementById('send').onclick = send;

  // Лише згенерувати base64-BOC (наприклад, щоб вставити в інший інструмент)
  document.getElementById('test').onclick = () => {
    const newAdmin = document.getElementById('newAdmin').value.trim();
    if (!isValidAddress(newAdmin)) {
      alert('New admin address некоректна');
      return;
    }
    const payload = buildChangeAdminPayload(newAdmin);
    log("Payload (base64 BOC):\n" + payload);
  };
})();
</script>
</body>
</html>
